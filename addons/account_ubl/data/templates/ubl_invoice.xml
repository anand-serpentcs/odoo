<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="ubl_party">
            <!-- This template must be called with a partner_id -->
            <cac:Party
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:WebsiteURI
                    t-if="self.website"
                    t-esc="self.website"/>
                <cac:PartyName>
                    <cbc:Name t-esc="self.name"/>
                </cac:PartyName>
                <cac:Language t-if="self.lang">
                    <cbc:LocaleCode t-esc="self.lang"/>
                </cac:Language>
                <cac:PostalAddress> 
                    <cbc:StreetName 
                        t-if="self.street" 
                        t-esc="self.street"/>
                    <cbc:AdditionalStreetName
                        t-if="self.street2" 
                        t-esc="self.street2"/>
                    <cbc:CityName 
                        t-if="self.city" 
                        t-esc="self.city"/>
                    <cbc:PostalZone 
                        t-if="self.zip" 
                        t-esc="self.zip"/>
                    <cbc:CountrySubentity 
                        t-if="self.state_id" 
                        t-esc="self.state_id.name"/>
                    <cbc:CountrySubentityCode 
                        t-if="self.state_id" 
                        t-esc="self.state_id.code"/>
                    <cac:Country 
                        t-if="self.country_id">
                        <cbc:IdentificationCode t-esc="self.country_id.code"/> 
                        <cbc:Name t-esc="self.country_id.name"/> 
                    </cac:Country>
                </cac:PostalAddress>
                <cac:PartyTaxScheme t-if="self.vat">
                    <cbc:RegistrationName t-esc="self.name"/>
                    <cbc:CompanyID t-esc="self.sanitized_vat"/>
                    <cac:TaxScheme>
                        <cbc:ID 
                            schemeID="UN/ECE 5153" 
                            schemeAgencyID="6"
                            >VAT</cbc:ID>
                    </cac:TaxScheme>
                </cac:PartyTaxScheme>
                <cac:Contact>
                    <cbc:Name t-esc="self.name"/>
                    <cbc:Telephone 
                        t-if="self.phone" 
                        t-esc="self.phone"/>
                    <cbc:Telefax 
                        t-if="self.phone" 
                        t-esc="self.fax"/>
                    <cbc:ElectronicMail 
                        t-if="self.phone" 
                        t-esc="self.email"/>
                </cac:Contact>
            </cac:Party>
        </template>
        
        <template id="ubl_invoice_line">
            <cac:InvoiceLine
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:ID t-esc="self.id"/>
                <cbc:Note 
                    t-foreach="self.notes"
                    t-as="note"
                    t-esc="note"/>
                <cbc:InvoicedQuantity 
                    t-esc="self.invoice_line_id.quantity"/>
                <cbc:LineExtensionAmount
                    t-att-currencyID="currency_name"
                    t-esc="self.invoice_line_id.price_subtotal"/>
                <cac:TaxTotal 
                    t-foreach="self.taxes"
                    t-as="tax">
                    <cbc:TaxAmount
                        t-att-currencyID="currency_name"
                        t-esc="tax.amount_tax"/>
                </cac:TaxTotal>
                <cac:Item>
                    <cbc:Description t-esc="self.description"/>
                    <cbc:Name t-esc="self.name"/>
                    <cac:SellersItemIdentification>
                        <cbc:ID t-esc="self.invoice_line_id.product_id.default_code"/>
                    </cac:SellersItemIdentification>
                    <cac:AdditionalItemProperty 
                        t-foreach="self.invoice_line_id.product_id.attribute_value_ids"
                        t-as="attribute_value_id">
                        <cbc:Name t-esc="attribute_value_id.attribute_id.name"/>
                        <cbc:Value t-esc="attribute_value_id.name"/>
                    </cac:AdditionalItemProperty>
                </cac:Item>
                <cac:Price>
                    <cbc:PriceAmount 
                        t-att-currencyID="currency_name"
                        t-esc="self.invoice_line_id.price_subtotal"/>
                    <cbc:BaseQuantity t-esc="self.invoice_line_id.quantity"/>
                </cac:Price>
            </cac:InvoiceLine>
        </template>

        <template id="ubl_invoice">
            <Invoice
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:UBLVersionID t-esc="version_id"/>
                <cbc:ID t-esc="self.number"/>
                <cbc:IssueDate t-esc="self.date_invoice"/>
                <cbc:InvoiceTypeCode t-esc="type_code"/>
                <cbc:Note 
                    t-foreach="notes"
                    t-as="note"
                    t-esc="note"/>
                <cbc:DocumentCurrencyCode t-esc="currency_name"/>
                <cac:AccountingSupplierParty t-call="account_ubl.ubl_party">
                        <t t-set="self" t-value="supplier_party"/>
                </cac:AccountingSupplierParty>
                <cac:AccountingCustomerParty t-call="account_ubl.ubl_party">
                        <t t-set="self" t-value="customer_party"/>
                </cac:AccountingCustomerParty>
                <cac:PaymentMeans>
                    <cbc:PaymentMeansCode 
                        listID="UN/ECE 4461" 
                        t-esc="42 if bank else 31"/>
                    <cbc:PaymentDueDate t-esc="self.date_due"/>
                    <cac:PayeeFinancialAccount t-if="bank and bank.acc_number">
                        <cbc:ID schemeName="IBAN" t-esc="bank.acc_number"/>
                        <cac:FinancialInstitutionBranch t-if="bank.bank_bic">
                            <cac:FinancialInstitution>
                                <cbc:ID schemeName="BIC" t-esc="bank.bank_bic"/>
                            </cac:FinancialInstitution>
                        </cac:FinancialInstitutionBranch>
                    </cac:PayeeFinancialAccount>
                </cac:PaymentMeans>
                <cac:PaymentTerms t-if="self.payment_term_id">
                    <cbc:Note t-esc="self.payment_term_id.name"/>
                </cac:PaymentTerms>
                <cac:TaxTotal t-if="not self.amount_tax == 0">
                    <cbc:TaxAmount
                        t-att-currencyID="currency_name"
                        t-esc="self.amount_tax"/>
                </cac:TaxTotal>
                <cac:LegalMonetaryTotal> 
                    <cbc:LineExtensionAmount 
                        t-att-currencyID="currency_name"
                        t-esc="amount_untaxed"/>
                    <cbc:TaxExclusiveAmount 
                        t-att-currencyID="currency_name"
                        t-esc="amount_untaxed"/>
                    <cbc:TaxInclusiveAmount 
                        t-att-currencyID="currency_name"
                        t-esc="amount_total"/>
                    <cbc:PrepaidAmount 
                        t-att-currencyID="currency_name"
                        t-esc="amount_prepaid"/>
                    <cbc:PayableAmount 
                        t-att-currencyID="currency_name"
                        t-esc="residual"/>
                </cac:LegalMonetaryTotal>
                <t 
                    t-foreach="invoice_lines" 
                    t-as="invoice_line"
                    t-call="account_ubl.ubl_invoice_line">
                        <t t-set="self" t-value="invoice_line"/>
                </t>
            </Invoice>
        </template>
    </data>
</odoo>